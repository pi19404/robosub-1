#!/usr/bin/env python
# COPYRIGHT: Robosub Club of the Palouse under the GPL v3
#
# Some quotes from http://www.gutenberg.org/files/84/84-h/84-h.htm
#   Frakenstein, or the Modern Prometheus
#   by Mary Wollstonecraft Shelly

# TODO This is hideous. We really should have a proper daemon,
# perhaps leveraging the Pyro library.

import argparse
import json
import os
import re
import time
from pprint import pprint
from subprocess import check_output, check_call, Popen, CalledProcessError

def get_fnames(mode, settings):
    fnames = set()
    for key, val in settings.items():
        if isinstance(val, dict):
            fnames.add(val[mode]['path'])
    None in fnames and fnames.remove(None)
    return fnames

def get_running(settings):
    running = []
    running_raw = check_output(['ps', '-e', '-o', 'pid,cmd']).splitlines()
    for entry in running_raw[1:]:
        pid, cmd = entry.strip().split(' ', 1)
        pid = pid.strip()
        cmd = cmd.strip()
        running.append([pid, cmd])
    release_fnames = get_fnames("release", settings)
    mock_fnames = get_fnames("mock", settings)
    robosub_running = []
    PID, PROG = 0, 1
    for fname in release_fnames.union(mock_fnames):
        for entry in running:
            if re.search(fname, entry[PROG]):
                robosub_running.append((entry[PROG], entry[PID]))

    return robosub_running


def main(args):
    settings = json.load(open(args.settings_path, 'r'))
    release_fnames = get_fnames("release", settings)
    mock_fnames = get_fnames("mock", settings)

    if args.kill:
        running = get_running(settings)
        PID = 0
        PROG = 1
        for prog, pid in running:
            print "Killing '{0}' with pid {1}".format(
                    prog, pid)
            check_call(['kill', '-9', pid])

        print """
Yet you, my creator, detest and spurn me, thy creature, to whom thou art bound
by ties only dissoluble by the annihilation of one of us. You purpose to kill
me. How dare you sport thus with life?
        """
    elif args.create:
        # TODO This branch does not check to see if the programs are already
        # running.
        FNULL = open(os.devnull, 'w')
        if not os.environ.get('PYTHONPATH'):
            os.environ['PYTHONPATH'] = os.path.abspath('.')

        # TODO This should check to see if any arguments are specified in
        # the settings file.
        if args.create == 'release':
            fnames = release_fnames
        elif args.create == 'mock':
            fnames = mock_fnames
        else:
            raise "--create argument not recognized: {0}".format(args.create)

        for fname in fnames:
            cmd = ['python', fname]
            print "Electrifying:", cmd
            Popen(cmd, stdout=FNULL, stderr=FNULL)

        FNULL.close()
        print
        print "I beheld the wretch--the miserable monster whom I had created."
        print

    if args.running:
        print '{0:>6}: {1}'.format("PID", "COMMAND")
        print '{0:=>6}: {1:=>10}'.format("", "")
        for prog, pid in get_running(settings):
            print '{pid:>6}: {prog}'.format(pid=pid, prog=prog)


def commandline():
    parser = argparse.ArgumentParser(description='Mock module.')
    parser.add_argument('--settings_path', type=str,
            default="./settings.json",
            help='Settings file path.')
    parser.add_argument('-c', '--create', type=str,
                        help="Would you also create for yourself and "
                             "the world a demoniacal enemy? (mock|release)")
    parser.add_argument('-k', '--kill', action='store_true',
                        help="He was tried and condemned to death.")
    parser.add_argument('-m', '--module_name', type=str,
            default='movement/directive',
            help='Module name.')
    parser.add_argument('-r', '--running', action='store_true')
    return parser.parse_args()


if __name__ == '__main__':
    main(commandline())

